# Cache

캐시의 종류를 많지만 여기서는 memcached 와 redis 만 비교해보

#### 둘 다 인메모리 캐시이다. 데이터 캐싱, 세션 관리, 실시간 데이터 처리 등 다양한 용도로 사용

### 차이점

데이터 구조
- Memcached : 단순한 키-값 저장소
- Redis : 다양한 데이터 구조 지원 (문자열, 리스트, 해시, 세트, 정렬된 세트 등)

멀티스레드 지원
- Memcached : 멀티 스레드 지원
- Redis : 단일 스레드 기반, I/O 멀티플렉싱으로 고성능 처리

데이터 영속성	
- 지원하지 않음 (모든 데이터는 메모리에만 저장됨)
- 지원 (스냅샷 RDB 및 AOF 방식 제공)

AOF 란
- AOF(Append Only File)는 레디스에서 데이터 영속성을 위해 사용하는 백업 방식으로, 모든 쓰기 요청에 대한 로그를 저장합니다.

읽기/쓰기
- 속도 매우 빠름	
- 빠르지만 다양한 데이터 구조 지원으로 약간 느릴 수 있음

### 어떤 방식이길래 속도 차이가 날까? 이것을 좀 더 알아보자

결론부터 말하자면 Memcached 는 slab Redis 는 jemalloc 방식을 사용한다고 한다.

이 부분은 데이터 구조를 보면 어느정도 납득이 간다.
우선 비교적 이해가 쉬운 Slab 부터 살펴보자

### Slab Allocation

1. Slab Allocation은 메모리를 정적인 크기(슬랩)로 나누어 관리하는 방식
2. 빠른 메모리 할당/해제가 가능하고 단순하고 어느정도 예측도 된다고한다.
3. **메모리 단편화가 발생할 수 있다**

메모리 단편화를 극복하기 위한 메커니즘은 뭐가 있을까?

(1) 초기 슬랩 크기 설계 

슬랩 클래스를 생성할 때, chunk 크기를 데이터 패턴에 맞게 설정하여 내부 단편화를 최소화.

(예: 32바이트, 64바이트, 128바이트 등 사용 빈도가 높은 크기를 중심으로 클래스 설정.)

(2) Rebalancing

사용 빈도가 낮은 슬랩 클래스에서 빈 슬랩을 회수하여, 사용 빈도가 높은 슬랩 클래스에 재할당.

Memcached는 이를 위한 slab rebalancing 기능을 제공합니다.

동작 방식:
1) 사용률이 낮은 슬랩 클래스를 감지.
2) 해당 클래스의 빈 슬랩을 회수.
3) 사용률이 높은 슬랩 클래스에 재할당.
4) 이 과정은 슬랩 단위로 이루어지며, 동작 중에도 진행 가능(중단 없는 재할당).

### JeMalloc

Redis에서 메모리가 할당될 때 Jemalloc이 동작하는 주요 단계는 다음과 같습니다:

1. Tcache 확인:

요청된 메모리 크기가 16KB 이하일 경우, Jemalloc은 스레드 로컬 캐시(Thread Cache, Tcache)에서 메모리를 확인합니다. 

Tcache에 사용 가능한 메모리가 있으면 즉시 할당합니다.

2. Arena 선택:

요청된 메모리 크기가 Tcache에 없거나, 16KB보다 큰 경우 : Jemalloc은 요청을 처리할 적절한 Arena를 선택합니다.

Arena는 Chunk에서 메모리를 할당하고 관리합니다.

3. Chunk 및 Bin 사용:

Arena는 요청 크기에 따라 적절한 Bin(동일 크기 메모리 블록 그룹)을 선택합니다. 

Bin 내에서 사용 가능한 메모리 블록을 할당하거나, 새로운 Run을 생성하여 메모리를 제공합니다.

Chunk는 운영 체제로부터 요청된 큰 메모리 블록이며, Bin과 Run을 통해 세분화됩니다.

JeMalloc 을 직접 과정을 보진 못했지만 이런식으로 동작한다고 한다.

#### 정리하자면 16kb 보다 작을 경우 Tcache 에서 사용 가능한 메모리가 있으면 즉시 할당하고 그 이상이면 Arena 는 요청에따라 적절한 빈을 선택하는것 같다.

#### 결론 : Memcached 는 데이터 구조가 단순하기 때문에 미리 할당한 크기를 사용해도 되는것 같은데 redis 는 사이즈가 다양할 수 있어서 Jemalloc 을 사용하는것 같다.
